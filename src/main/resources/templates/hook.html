<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title th:text="${applicationName}+'-'+${id}"></title>
    <style>
        .treeview span.indent {
            margin-left: 10px;
            margin-right: 10px
        }

        .treeview span.icon {
            width: 12px;
            margin-right: 5px
        }

        .treeview .node-disabled {
            color: silver;
            cursor: not-allowed
        }

        .node-treeview1:not(.node-disabled):hover {
            background-color: #F5F5F5;
        }

        li {
            cursor: pointer;
        }

        .input-group-addon {
            min-width: 100px;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
          integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">

    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" th:src="@{/js/bootstrap-treeview.min.js}"></script>
    <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>


</head>
<body>
<div class="page-header">
    <h1><span th:text="${applicationName}"></span>
        <small id="small" th:text="${id}"></small>
    </h1>

</div>

<ul id="myTab" class="nav nav-tabs">
    <li class="active">
        <a href="#home" data-toggle="tab">Hook</a>
    </li>
    <li><a href="#classmap" data-toggle="tab" onclick="load_classMap()">类图</a></li>
    <li><a href="#plugins-tab" data-toggle="tab" >插件</a></li>

    <li class="dropdown ">
        <a href="#" id="myTabDrop1" data-toggle="dropdown">功能 <b class="caret"></b>
        </a>
        <ul class="dropdown-menu" role="menu" aria-labelledby="myTabDrop1">
            <li><a th:href="@{/hook/export(id=${id})}" th:target="_blank" tabindex="-1">
                导出Hook</a>
            </li>
            <li><a th:href="@{/hook/export-offline(id=${id})}" th:target="_blank" tabindex="-1">
                导出Agent</a>
            </li>
        </ul>
    </li>
</ul>

<!-- tab content start-->
<div id="myTabContent" class="tab-content">
    <!-- add hook start-->
    <div class="modal fade" id="add_hook_dialog" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content" style="width: 650px;">
                <div class="modal-header">
                    <h4 class="modal-title">添加hook点</h4>
                </div>
                <div class="modal-body">
                    <form id="hook_form" action="/hook/add" method="POST">
                        <div class="input-group">
                            <span class="input-group-addon">ClassName</span>
                            <input type="text" id="className" class="form-control" placeholder="ClassName"
                                   aria-describedby="basic-addon1">
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon">Method</span>
                            <input type="text" id="method" class="form-control" placeholder="Method"
                                   aria-describedby="basic-addon1">
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon">Desc</span>
                            <input type="text" id="desc" class="form-control" placeholder="Desc"
                                   aria-describedby="basic-addon1">
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon">修改返回值</span>
                            <input type="text" id="returnValue" class="form-control" placeholder="value"
                                   aria-describedby="basic-addon1">
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon">方法执行前</span>
                            <div class="dropdown">
                                <button type="button" class="btn dropdown-toggle" id="dropdownMenu1"
                                        data-toggle="dropdown">
                                    添加行为
                                </button>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                                    <li role="presentation">
                                        <a role="menuitem" tabindex="-1" href="javascript:addMethod('onMethodEnter')">添加静态方法</a>
                                    </li>
                                    <li role="presentation">
                                        <a role="menuitem" tabindex="-1" href="javascript:addField('onMethodEnter')">添加修改参数</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div id="onMethodEnter">
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon">方法执行后</span>
                            <div class="dropdown">
                                <button type="button" class="btn dropdown-toggle" id="dropdownMenu2"
                                        data-toggle="dropdown">
                                    添加行为
                                </button>
                                <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu2">
                                    <li role="presentation">
                                        <a role="menuitem" tabindex="-1" href="javascript:addMethod('onMethodExit')">添加静态方法</a>
                                    </li>
                                    <li role="presentation">
                                        <a role="menuitem" tabindex="-1" href="javascript:addField('onMethodExit')">添加修改参数</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div id="onMethodExit">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="addHook" type="button" class="btn btn-default">添加</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <!-- add hook end-->
    <!-- classmap start-->
    <div class="tab-pane fade" id="classmap">

        <div class="row">
            <div class="col-sm-2">
                <div id="treeview1" class="treeview pre-scrollable"></div>
            </div>
            <div class="col-sm-8" id="classDetail">
                <h5 id="packageName"></h5>
                <h3 id="class">Class</h3>

            </div>
        </div>
    </div>

    <!-- classmap end-->
    <div class="tab-pane fade in active" id="home">
        <div id="toolbar" class="btn-group">
            <button id="btn_add" type="button" class="btn btn-default" data-toggle="modal"
                    data-target="#add_hook_dialog">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
            </button>
            <button id="btn_edit" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
            </button>
            <button id="btn_delete" type="button" class="btn btn-default" onclick="del_hook()">
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
            </button>
        </div>
        <table id="tb_departments"></table>
    </div>
    <div class="tab-pane fade" id="plugins-tab">
        <div id="plugin_toolbar" class="btn-group">
            <button id="plugin_add" type="button" class="btn btn-default" data-toggle="modal"
                    data-target="#add_app">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
            </button>
        </div>
        <table id="plugin_departments"></table>
    </div>
<!--    <div class="tab-pane fade" id="ejb">-->
<!--        <p>Enterprise Java Beans（EJB）是一个创建高度可扩展性和强大企业级应用程序的开发架构，部署在兼容应用程序服务器（比如 JBOSS、Web Logic 等）的 J2EE 上。-->
<!--        </p>-->
<!--    </div>-->
</div>
<!-- tab content end-->



<script>

</script>
<script>
    $(function () {
        //1.初始化Table
        var oTable = new TableInit();
        oTable.Init();

    });

// home页面列表 start
    var TableInit = function () {
        var oTableInit = new Object();
        //初始化Table
        oTableInit.Init = function () {
            $('#tb_departments').bootstrapTable({
                url: '/hook/find',         //请求后台的URL（*）
                method: 'get',                      //请求方式（*）
                dataType: 'json',
                toolbar: '#toolbar',                //工具按钮用哪个容器
                theadClasses: '.thead-light',
                striped: true,                      //是否显示行间隔色
                cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                pagination: true,                   //是否显示分页（*）
                showPaginationSwitch: false,        //是否显示分页数
                sortable: false,                     //是否启用排序
                sortName: "title",                     //是否启用排序
                sortOrder: "desc",                   //排序方式
                queryParams: oTableInit.queryParams,//传递参数（*）
                queryParamsType: '',                //如果要在oTableInit.queryParams方法获取pageNumber和pageSize的值，需要将此值设置为空字符串（*）
                sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
                pageNumber: 1,                       //初始化加载第一页，默认第一页
                pageSize: 10,                       //每页的记录行数（*）
                pageList: [10, 25, 50, 100],        //可供选择的每页的行数（*）
                search: false,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
                strictSearch: true,
                showColumns: true,                  //是否显示所有的列
                showRefresh: true,                  //是否显示刷新按钮
                minimumCountColumns: 2,             //最少允许的列数
                clickToSelect: true,                //是否启用点击选中行
                singleSelect: true,                 //是否单选模式
                height: $(window).height() - 200,   //table总高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
                uniqueId: "ID",                     //每一行的唯一标识，一般为主键列
                showToggle: false,                    //是否显示详细视图和列表视图的切换按钮
                cardView: false,                    //是否显示详细视图
                detailView: false,                   //是否显示父子表
                paginationPreText: "上一页",
                paginationNextText: "下一页",
                onClickRow: function (row, $element) {
                    console.log("click:" + row["id"])
                },
                columns: [
                    {
                        checkbox: true,
                        align: 'center',
                        valign: 'middle'
                    }, {
                        field: 'id',
                        title: 'id'
                    }, {
                        field: 'className',
                        title: '类名'
                    }, {
                        field: 'method',
                        title: '方法'
                    }, {
                        field: 'desc',
                        title: '描述符'
                    }, {
                        field: 'returnValue',
                        title: '返回值',
                    },]
            });
        };
        oTableInit.queryParams = function (params) {
            // alert(JSON.stringify(params));
            var temp = {   //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                id: $("#small").text(),
                // statu: $("#txt_search_statu").val()
            };
            return temp;
        };
        return oTableInit;
    };

    function refresh() {
        $('#tb_departments').bootstrapTable('refresh', {
            query: {
                pageNumber: 1
            }
        });
    }

    function del_hook() {
        let selected = $(".selected");
        if (selected.length === 0) {
            alert("未选择删除的hook点");
            return;
        }

        let id = selected.children("td")[1].innerHTML;
        $.ajax({
            url: "/hook/del?hookId=" + id,
            type: "get",
            success: function (data) {
                refresh();
            },
            error: function () {
            }
        });
    }
    // home页面end

    function getOnMethodAction(id) {
        let type;
        if (id.indexOf("Enter") >= 0) type = 1;
        else type = 2;


        let onMethodEnter = $("#" + id);
        let methods = [];
        let fields = [];
        let childNodes = onMethodEnter.children();
        for (let i = 0; i < childNodes.length; i++) {
            let node = childNodes[i];
            let classNode = node.className;
            if (classNode.indexOf("method") > 0) {
                let className = node.children[1].value;
                let method = node.children[2].value;
                let desc = node.children[3].value;
                let parameters = node.children[4].value;
                methods.push(
                    {
                        "className": className,
                        "methodName": method,
                        "desc": desc,
                        "parameters": parameters,
                        "index": i
                    }
                );
            } else {
                let name = node.children[1].value;
                let value = node.children[2].value;
                fields.push(
                    {
                        "name": name,
                        "value": value,
                        "sort": i
                    }
                );
            }
        }
        return {
            "type": type,
            "methods": methods,
            "fields": fields
        };
    }

    $('#addHook').click(function () {
        let url = '/hook/add';
        let onMethodAction = [
            getOnMethodAction("onMethodEnter"),
            getOnMethodAction("onMethodExit")
        ]
        console.log(onMethodAction);
        $.ajax({
            //async:false,非异步，modal窗口失效；
            async: true,
            url: url,
            type: 'POST',
            data: JSON.stringify({
                agentId: $("small").text(),
                className: $('#className').val(),
                desc: $('#desc').val(),
                method: $('#method').val(),
                returnValue: $('#returnValue').val(),
                "onMethodAction": onMethodAction
            }),
            dataType: 'html',
            contentType: 'application/json',
        }).done(function (data) {
            refresh();
            setTimeout(function () {
                $('#add_hook_dialog').modal('hide');
            }, 200);
        })

    });
    index = 0;

    function addField(id) {
        var content = `<div class="input-group field" style="padding-left: 10px" id="content${index}" >
                                <span class="input-group-addon">参数</span>
                                <input type="text"  style="width: 45%" class="form-control"  placeholder="参数名"
                                       aria-describedby="basic-addon1">
                                <input type="text" style="width: 50%" class="form-control" placeholder="参数值"
                                       aria-describedby="basic-addon2">
                                <a href="javascript:remove('content${index}')" style="width: 5%">
                                    <span class="glyphicon glyphicon-remove"></span>
                                </a>
                            </div>`;
        index++;
        var fieldForm = $("#" + id);
        fieldForm.append(content);
    }

    function addMethod(id) {
        var content = `<div class="input-group method" style="padding-left: 10px" id="content${index}">
                                <span class="input-group-addon">静态方法</span>
                                <input type="text"  style="width: 35%" class="form-control"  name="className" placeholder="class name"
                                       aria-describedby="basic-addon1">
                                <input type="text" style="width: 15%" class="form-control" name="method" placeholder="method"
                                       aria-describedby="basic-addon2">
                                <input type="text" style="width: 20%" class="form-control" name="desc" placeholder="desc"
                                       aria-describedby="basic-addon2">
                                <input type="text" style="width: 25%" class="form-control" name="parameter" placeholder="参数"
                                       aria-describedby="basic-addon2">
                                <a href="javascript:remove('content${index}')" style="width: 5%">
                                    <span class="glyphicon glyphicon-remove"></span>
                                </a>
                            </div>`;
        index++;
        let fieldForm = $("#" + id);
        fieldForm.append(content);
    }

    function remove(id) {
        let d = $("#" + id);
        d.remove();
    }
</script>
<script>
    var $table = $('#table')
    $(function () {
        $('#modalTable').on('shown.bs.modal', function () {
            $table.bootstrapTable('resetView')
        })
    })
</script>
<script>
    function load_classMap() {
        var url = "/classmap/all?agentId=" + $("#small").text();
        $.ajax({
            //async:false,非异步，modal窗口失效；
            async: true,
            url: url,
            type: 'GET',
            dataType: 'json',
        }).done(function (data) {
            var defaultData = [];
            for (var i = 0, l = data.length; i < l; i++) {
                var className = data[i]["className"]
                defaultData[i] = {
                    text: className,
                    href: '#' + data[i]["packageName"],
                    tags: [i]
                }
            }
            $('#treeview1').treeview({
                data: defaultData,
                collapseIcon: 'fas fa-minus',
                expandIcon: 'fas fa-plus'
            }).on('nodeSelected', function (event, data) {
                console.log(data["text"]);
                $('#class').text("Class " + data["text"]);
                $('#packageName').text(data["href"].substring(1).replaceAll("/", "."));
            });
        })
    }

</script>

</body>


</html>